#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>

#define BASE_TYPE uint32_t
#include "DIY_BigNum.h"

Bign isqrt(Bign *num){
    Bign res, bit, res_plus_bit, tmp1;
    Bign_init(&res, num->size);
    Bign_init(&bit, num->size);
    Bign_init(&res_plus_bit, num->size);

    Bign_init(&tmp1, num->size);

    Bign_from_int(&bit,1);
    Bign_shift_left(&bit,&bit, (num->size - 1)*TYPE_SIZE_BITS + TYPE_SIZE_BITS - 2);
    
    //Bign_print_hex(&bit);
    //Bign_print_hex(num);

    //printf("%d \n", Bign_biggerThan(&bit, num));

    while(Bign_biggerThan(&bit, num)){
        //Bign_zero(&tmp1);
        Bign_shift_right(&bit,&bit,2);
        //Bign_cpy(&tmp1,&bit);
    }


    while(!Bign_equals_zero(&bit)){
        //Bign_zero(&res_plus_bit);
        Bign_add(&res,&bit, &res_plus_bit);
        
        //Bign_print_hex(&res_plus_bit);

        if(Bign_biggerOrEquals(num, &res_plus_bit)){
            
            //Bign_zero(&tmp1);
            Bign_sub(num, &res_plus_bit, &tmp1);
            Bign_cpy(&tmp1,num);

            //if(Bign_biggerThan(&res_plus_bit,num)) printf("truble????????????????????\n");

            //Bign_zero(&tmp1);
            Bign_shift_right_one(&res,&tmp1);
            Bign_cpy(&tmp1,&res);

            //Bign_zero(&tmp1);
            Bign_add(&res,&bit,&tmp1);
            Bign_cpy(&tmp1,&res);

            //Bign_print_hex(&res);
        }else{
            //Bign_zero(&tmp1);
            Bign_shift_right_one(&res,&tmp1);
            Bign_cpy(&tmp1,&res);

            //Bign_print_hex(&res);
        }

        Bign_shift_right(&bit,&tmp1,2);
        Bign_cpy(&tmp1,&bit);
    }

    Bign_free_data(&bit);
    Bign_free_data(&res_plus_bit);
    return res;

}

int main(int argc, char **argv){

    Bign a, b;
    Bign_init(&a, 208);

    //printf("zero: %d\n",Bign_equals_zero(&a));

    //Bign_from_int(&a, 2);
    //Bign_shift_left(&a,&a, (a.size - 2)*TYPE_SIZE_BITS);


                    // 2^1000
    Bign_from_hexstr(&a,//"79C6D8FCEE9ED602BC694B4A9CDE5B6957D0F95655C658F47D1D9E6C8A76B354428D65E2243ABDFAFE2B9A6EEA91D5EC40682091EB34E45E2550915F68875D1831F8DCC57EC2E52AAA215BF709CD7542CD40AD0C8373D0D293F30BB4FA4A677C136CF41CA85876B2A80451B31D89C7B3AE21DC1FCEEE53AFC8D31E18102C5014505CA7669CAC1402CBAAAA455D4F0FB41787D6B5FEFA9212797107DEA79A73905672DF2B95B51185F6E5B996487A6CF170B8C423D990CF4001AEF3844B33399BA0DF83505317EFEDCA2769233035630BA95F1FA0F6A295275B2B6CE1B7AEE9D8D0C9445870EB236778F3A2DA998ED4379535296F5A20B09490EE8F0C25BB6D300BCF8658A4F21A73796329096A71D0043E8AB684DCBAB1F35852F4EBE8C79CEDC4CC20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
                    // 2^2000
                        "1CF6C9C9BC5F884A294E53EDC955F57D1EFA78271816AAFD3571B9C977634B1F08432E269307615C66D97BE7B2E17D3C04657258EC100171CAB4B9EB895A63EEFB9048C425CEA92BA9463490C0A743F3EA62AB3899521BE541FA939FDC556606CDC807AB46C1FB60327EE14823B5E5C8787B499E077C1B816110FAF5396BF916253D8AA0C182F9A38CEA6BC188CF5B47E6F7EA8C28632ED0BECBDF10170C70782D73B32B0BDE8443AE648B17C6DC917CC258BE20AB93F921E85B01C83E3330DED2892AAF8B5810DB741CC45E4FF17365AB05A8E208A44BDA5133B1F857420B886FEE1200CE2CABC0644FEADEF8CEB260ED5644AB07FC8718C65592C9536B4667DD9FB1CEA42BFDF7CFC89C6FAE957AC4A37193B545AFF7C0E23CAC44F638DDAA16AC25A558B2FA23C6C05917D5AE4BC0E7B7D98670BD208B48078142E861E985450EB34426C829C55FCDE13172585747C692B985336F5A8078255F5BE70447B904BF0F6F1AA72C2C38FC03859FFD84ADFF3AE571DEF3D2A16D8A983433190572CECADC213335D6F49C5B5FE3C02CE76D34F5CA129625D9D82874BFC1657D06200BB8FD0D8A4919AEA408F071C654B96B5D128B3638D99BEE2D1BC8136105B5C6B42DD204AF751C95098FD0A604F47D77984A169A7008CFF8E68BBADDF3F077887E2330DC949EC5399AA246CE1C82A20224CDA1B8906647E3B48F0876094A3D92BBDE6484542B6026B743583BF8EA662959EE4B5B8BCB7B5FD5F6F34406F2F9C957B515DBC264D5EFF561A227DE5DA62F9C48CFB22B99B7050A5676429D27AA04401E39E18200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000");
    Bign_print_hex(&a);
    printf("sqrt of 2: \n");
    //Bign_from_int(&a,200000000);
    
    
    // does not work when type uint64_t....
    b = isqrt(&a);
    Bign_print_hex(&b);
}
